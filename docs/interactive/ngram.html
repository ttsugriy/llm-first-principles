<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N-gram State Machine Visualizer</title>
    <script src="https://unpkg.com/d3@7"></script>
    <style>
        :root {
            --bg-color: #ffffff;
            --text-color: #333333;
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --accent-color: #e74c3c;
            --border-color: #dddddd;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #1a1a2e;
                --text-color: #eaeaea;
                --primary-color: #4fc3f7;
                --secondary-color: #81c784;
                --accent-color: #ef5350;
                --border-color: #333355;
            }
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .subtitle {
            text-align: center;
            color: #888;
            margin-bottom: 30px;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input[type="text"], select {
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            background: var(--bg-color);
            color: var(--text-color);
        }

        input[type="text"] {
            width: 300px;
        }

        button {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: opacity 0.2s;
        }

        button:hover {
            opacity: 0.9;
        }

        button.secondary {
            background-color: var(--secondary-color);
        }

        .visualization {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .graph-container {
            flex: 2;
            min-width: 500px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        #graph {
            width: 100%;
            height: 500px;
        }

        .info-panel {
            flex: 1;
            min-width: 280px;
        }

        .panel {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .panel h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #888;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .stat {
            text-align: center;
            padding: 10px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 6px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            color: #888;
        }

        .transition-table {
            max-height: 300px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            font-weight: 600;
            position: sticky;
            top: 0;
            background: var(--bg-color);
        }

        .prob-bar {
            height: 8px;
            background: var(--primary-color);
            border-radius: 4px;
        }

        .current-state {
            padding: 10px;
            background: rgba(46, 204, 113, 0.1);
            border-radius: 6px;
            font-family: monospace;
            font-size: 16px;
            text-align: center;
        }

        .generated-text {
            font-family: monospace;
            font-size: 14px;
            line-height: 1.6;
            padding: 10px;
            background: rgba(0,0,0,0.05);
            border-radius: 6px;
            min-height: 60px;
            word-wrap: break-word;
        }

        .generated-text .new-char {
            background: var(--secondary-color);
            color: white;
            padding: 0 2px;
            border-radius: 2px;
        }

        /* D3 styling */
        .node circle {
            stroke-width: 2px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .node:hover circle {
            stroke-width: 3px;
        }

        .node.current circle {
            stroke: var(--accent-color);
            stroke-width: 3px;
        }

        .node text {
            font-size: 11px;
            pointer-events: none;
        }

        .link {
            fill: none;
            stroke: var(--border-color);
            stroke-width: 1.5px;
            opacity: 0.6;
        }

        .link.active {
            stroke: var(--accent-color);
            stroke-width: 3px;
            opacity: 1;
        }

        .link-label {
            font-size: 10px;
            fill: #888;
        }

        .instructions {
            background: rgba(52, 152, 219, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .instructions h3 {
            margin: 0 0 10px 0;
            color: var(--primary-color);
        }

        .instructions ul {
            margin: 0;
            padding-left: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>N-gram State Machine Visualizer</h1>
        <p class="subtitle">Watch how Markov chains process text as a state machine</p>

        <div class="instructions">
            <h3>How to Use</h3>
            <ul>
                <li><strong>Train</strong>: Enter text and click "Train Model" to build the Markov chain</li>
                <li><strong>Generate</strong>: Click "Generate Step" to sample one character at a time</li>
                <li><strong>Observe</strong>: Watch the state transitions in the graph and probability table</li>
            </ul>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>Training Text</label>
                <input type="text" id="training-text" value="to be or not to be that is the question" placeholder="Enter training text...">
            </div>
            <div class="control-group">
                <label>Order</label>
                <select id="order">
                    <option value="1">1 (Bigram)</option>
                    <option value="2" selected>2 (Trigram)</option>
                    <option value="3">3 (4-gram)</option>
                </select>
            </div>
            <button onclick="trainModel()">Train Model</button>
            <button class="secondary" onclick="generateStep()">Generate Step</button>
            <button class="secondary" onclick="resetGeneration()">Reset</button>
        </div>

        <div class="visualization">
            <div class="graph-container">
                <svg id="graph"></svg>
            </div>

            <div class="info-panel">
                <div class="panel">
                    <h3>Model Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat">
                            <div class="stat-value" id="state-count">0</div>
                            <div class="stat-label">States</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="transition-count">0</div>
                            <div class="stat-label">Transitions</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="vocab-size">0</div>
                            <div class="stat-label">Vocab Size</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value" id="order-display">2</div>
                            <div class="stat-label">Order</div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h3>Current State</h3>
                    <div class="current-state" id="current-state">—</div>
                </div>

                <div class="panel">
                    <h3>Transition Probabilities</h3>
                    <div class="transition-table" id="transition-table">
                        <p style="color: #888; text-align: center;">Train a model to see transitions</p>
                    </div>
                </div>

                <div class="panel">
                    <h3>Generated Text</h3>
                    <div class="generated-text" id="generated-text">—</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ====================================================================
        // Markov Chain Implementation (matches Python version)
        // ====================================================================

        class MarkovChain {
            constructor(order = 2) {
                this.order = order;
                this.counts = new Map();  // Map<string, Map<string, number>>
                this.totals = new Map();  // Map<string, number>
                this.vocab = new Set();
            }

            train(tokens) {
                // Pad with START tokens
                const padded = [];
                for (let i = 0; i < this.order; i++) {
                    padded.push('<S>');
                }
                padded.push(...tokens);
                padded.push('<E>');

                // Count n-grams
                for (let i = 0; i < padded.length - this.order; i++) {
                    const history = padded.slice(i, i + this.order).join('');
                    const next = padded[i + this.order];

                    if (!this.counts.has(history)) {
                        this.counts.set(history, new Map());
                        this.totals.set(history, 0);
                    }

                    const transitions = this.counts.get(history);
                    transitions.set(next, (transitions.get(next) || 0) + 1);
                    this.totals.set(history, this.totals.get(history) + 1);
                    this.vocab.add(next);
                }
            }

            getDistribution(history) {
                if (!this.counts.has(history)) {
                    return new Map();
                }
                const transitions = this.counts.get(history);
                const total = this.totals.get(history);
                const dist = new Map();
                for (const [token, count] of transitions) {
                    dist.set(token, count / total);
                }
                return dist;
            }

            sample(history) {
                const dist = this.getDistribution(history);
                if (dist.size === 0) return null;

                const r = Math.random();
                let cumsum = 0;
                for (const [token, prob] of dist) {
                    cumsum += prob;
                    if (r < cumsum) return token;
                }
                return [...dist.keys()][0];
            }

            numStates() {
                return this.counts.size;
            }

            numTransitions() {
                let total = 0;
                for (const transitions of this.counts.values()) {
                    total += transitions.size;
                }
                return total;
            }
        }

        // ====================================================================
        // Visualization State
        // ====================================================================

        let model = null;
        let currentHistory = null;
        let generatedText = '';
        let simulation = null;

        // ====================================================================
        // D3 Graph Visualization
        // ====================================================================

        function buildGraphData() {
            if (!model) return { nodes: [], links: [] };

            const nodes = [];
            const links = [];
            const nodeMap = new Map();

            // Create nodes for each state
            let id = 0;
            for (const [state, transitions] of model.counts) {
                nodeMap.set(state, id);
                nodes.push({
                    id: id,
                    label: state.replace(/<S>/g, '⟨S⟩').replace(/<E>/g, '⟨E⟩'),
                    state: state,
                    count: model.totals.get(state)
                });
                id++;
            }

            // Create links for transitions
            for (const [state, transitions] of model.counts) {
                const sourceId = nodeMap.get(state);
                for (const [next, count] of transitions) {
                    // Find target state
                    const targetState = state.slice(1) + next;
                    if (nodeMap.has(targetState)) {
                        const prob = count / model.totals.get(state);
                        links.push({
                            source: sourceId,
                            target: nodeMap.get(targetState),
                            prob: prob,
                            token: next === '<E>' ? '⟨E⟩' : next
                        });
                    }
                }
            }

            return { nodes, links };
        }

        function renderGraph() {
            const svg = d3.select('#graph');
            svg.selectAll('*').remove();

            const width = svg.node().getBoundingClientRect().width;
            const height = 500;

            const { nodes, links } = buildGraphData();

            if (nodes.length === 0) {
                svg.append('text')
                    .attr('x', width / 2)
                    .attr('y', height / 2)
                    .attr('text-anchor', 'middle')
                    .attr('fill', '#888')
                    .text('Train a model to see the state machine');
                return;
            }

            // Create force simulation
            simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(80))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(30));

            // Create arrow marker
            svg.append('defs').append('marker')
                .attr('id', 'arrowhead')
                .attr('viewBox', '-0 -5 10 10')
                .attr('refX', 20)
                .attr('refY', 0)
                .attr('orient', 'auto')
                .attr('markerWidth', 6)
                .attr('markerHeight', 6)
                .append('path')
                .attr('d', 'M 0,-5 L 10,0 L 0,5')
                .attr('fill', '#999');

            // Create links
            const link = svg.append('g')
                .selectAll('path')
                .data(links)
                .join('path')
                .attr('class', 'link')
                .attr('marker-end', 'url(#arrowhead)')
                .attr('stroke-width', d => 1 + d.prob * 3);

            // Create nodes
            const node = svg.append('g')
                .selectAll('g')
                .data(nodes)
                .join('g')
                .attr('class', 'node')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            node.append('circle')
                .attr('r', d => 15 + Math.log(d.count + 1) * 3)
                .attr('fill', d => d.state === currentHistory ? '#e74c3c' : '#3498db')
                .attr('stroke', '#fff');

            node.append('text')
                .attr('dy', 4)
                .attr('text-anchor', 'middle')
                .attr('fill', 'white')
                .text(d => d.label.length > 4 ? d.label.slice(-3) : d.label);

            // Update positions on tick
            simulation.on('tick', () => {
                link.attr('d', d => {
                    const dx = d.target.x - d.source.x;
                    const dy = d.target.y - d.source.y;
                    return `M${d.source.x},${d.source.y}L${d.target.x},${d.target.y}`;
                });

                node.attr('transform', d => `translate(${d.x},${d.y})`);
            });

            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }

            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }

            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }
        }

        function highlightCurrentState() {
            d3.selectAll('.node circle')
                .attr('fill', d => d.state === currentHistory ? '#e74c3c' : '#3498db');

            d3.selectAll('.node')
                .classed('current', d => d.state === currentHistory);
        }

        // ====================================================================
        // UI Functions
        // ====================================================================

        function trainModel() {
            const text = document.getElementById('training-text').value;
            const order = parseInt(document.getElementById('order').value);

            model = new MarkovChain(order);
            model.train([...text]);

            // Update stats
            document.getElementById('state-count').textContent = model.numStates();
            document.getElementById('transition-count').textContent = model.numTransitions();
            document.getElementById('vocab-size').textContent = model.vocab.size;
            document.getElementById('order-display').textContent = order;

            // Reset generation
            resetGeneration();

            // Render graph
            renderGraph();
        }

        function resetGeneration() {
            if (!model) return;

            currentHistory = '<S>'.repeat(model.order);
            generatedText = '';

            document.getElementById('current-state').textContent =
                currentHistory.replace(/<S>/g, '⟨S⟩');
            document.getElementById('generated-text').textContent = '—';

            updateTransitionTable();
            highlightCurrentState();
        }

        function generateStep() {
            if (!model || !currentHistory) {
                alert('Please train a model first!');
                return;
            }

            const next = model.sample(currentHistory);

            if (next === null || next === '<E>') {
                document.getElementById('generated-text').innerHTML =
                    generatedText + '<span class="new-char">⟨END⟩</span>';
                return;
            }

            generatedText += next;
            currentHistory = currentHistory.slice(1) + next;

            // Update display
            document.getElementById('current-state').textContent =
                currentHistory.replace(/<S>/g, '⟨S⟩').replace(/<E>/g, '⟨E⟩');

            const displayText = generatedText.slice(0, -1) +
                '<span class="new-char">' + generatedText.slice(-1) + '</span>';
            document.getElementById('generated-text').innerHTML = displayText;

            updateTransitionTable();
            highlightCurrentState();
        }

        function updateTransitionTable() {
            const container = document.getElementById('transition-table');

            if (!model || !currentHistory) {
                container.innerHTML = '<p style="color: #888; text-align: center;">Train a model to see transitions</p>';
                return;
            }

            const dist = model.getDistribution(currentHistory);

            if (dist.size === 0) {
                container.innerHTML = '<p style="color: #888; text-align: center;">No transitions from this state</p>';
                return;
            }

            // Sort by probability
            const sorted = [...dist.entries()].sort((a, b) => b[1] - a[1]);

            let html = '<table><thead><tr><th>Token</th><th>Prob</th><th></th></tr></thead><tbody>';

            for (const [token, prob] of sorted) {
                const displayToken = token === '<E>' ? '⟨END⟩' : token;
                html += `<tr>
                    <td><code>${displayToken}</code></td>
                    <td>${(prob * 100).toFixed(1)}%</td>
                    <td><div class="prob-bar" style="width: ${prob * 100}%"></div></td>
                </tr>`;
            }

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            trainModel();
        });
    </script>
</body>
</html>
